<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تفاصيل اللعبة</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* كل أنماط CSS السابقة تبقى كما هي */
    /* ... */
  </style>
</head>
<body>
  <div class="container">
    <!-- باقي الواجهة تبقى كما هي -->
    <!-- ... -->
  </div>

  <script>
    // دالة لفتح قاعدة البيانات - معدلة
    const openDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('GamesDatabase', 6); // إصدار 6
        
        request.onblocked = () => {
          console.log('قاعدة البيانات مقفولة بواسطة تبويب آخر');
          reject(new Error('قاعدة البيانات مقفولة'));
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('games')) {
            db.createObjectStore('games', { keyPath: 'id', autoIncrement: true });
          }
        };
        
        request.onsuccess = () => {
          const db = request.result;
          db.onversionchange = () => {
            db.close();
            alert('تم تحديث قاعدة البيانات. يرجى إعادة تحميل الصفحة.');
          };
          resolve(db);
        };
        
        request.onerror = (event) => {
          console.error('فشل فتح قاعدة البيانات:', event.target.error);
          reject(event.target.error);
        };
      });
    };

    // دالة للحصول على لعبة بواسطة ID - معدلة
    const getGameById = async (id) => {
      try {
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const transaction = db.transaction('games', 'readonly');
          const store = transaction.objectStore('games');
          
          // تحويل ID إلى رقم صحيح
          const gameId = typeof id === 'string' ? parseInt(id) : id;
          if (isNaN(gameId)) {
            throw new Error('معرف اللعبة غير صالح');
          }
          
          const request = store.get(gameId);
          
          request.onsuccess = () => {
            if (request.result) {
              resolve(request.result);
            } else {
              console.error('اللعبة غير موجودة في قاعدة البيانات');
              resolve(null);
            }
          };
          request.onerror = () => {
            console.error('خطأ في الوصول إلى قاعدة البيانات:', request.error);
            reject(request.error);
          };
        });
      } catch (error) {
        console.error('حدث خطأ جسيم:', error);
        return null;
      }
    };

    // تحميل بيانات اللعبة - معدلة
    async function loadGame() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('id');
        
        console.log('معرف اللعبة من URL:', gameId); // Debug
        
        if (!gameId) {
          throw new Error('لم يتم تحديد معرف اللعبة في الرابط');
        }

        const game = await getGameById(gameId);
        console.log('بيانات اللعبة المسترجعة:', game); // Debug
        
        if (!game) {
          throw new Error('اللعبة غير موجودة في قاعدة البيانات');
        }

        // عرض بيانات اللعبة
        document.getElementById('gameTitle').textContent = game.title || "لعبة بدون عنوان";
        document.getElementById('gameDescription').textContent = game.fullDesc || "لا يوجد وصف مفصل";
        document.getElementById('gameCompany').textContent = game.company || "غير معروف";
        document.getElementById('gameSize').textContent = game.size || "غير معروف";
        document.getElementById('gamePlatform').textContent = game.platform || "غير معروف";
        document.getElementById('gameOs').textContent = game.os || "غير معروف";
        document.getElementById('gameBit').textContent = game.bit ? `${game.bit} بت` : "غير معروف";
        document.getElementById('gameDevices').textContent = game.devices ? game.devices.join(', ') : "غير معروف";

        // عرض الصور
        const gallery = document.getElementById('gameGallery');
        const images = game.images || {};
        gallery.innerHTML = ''; // مسح الصور القديمة
        
        if (game.image) gallery.innerHTML += `<img src="${game.image}" alt="الصورة الرئيسية">`;
        if (images.img1) gallery.innerHTML += `<img src="${images.img1}" alt="صورة اللعبة 1">`;
        if (images.img2) gallery.innerHTML += `<img src="${images.img2}" alt="صورة اللعبة 2">`;
        if (images.img3) gallery.innerHTML += `<img src="${images.img3}" alt="صورة اللعبة 3">`;
        if (images.img4) gallery.innerHTML += `<img src="${images.img4}" alt="صورة اللعبة 4">`;

        // إعداد زر التحميل
        const downloadBtn = document.getElementById('downloadBtn');
        const countdownEl = document.getElementById('countdown');

        if (game.downloadLink) {
          downloadBtn.addEventListener('click', function() {
            downloadBtn.disabled = true;
            
            let timeLeft = 5;
            countdownEl.textContent = `جاري التجهيز للتحميل... ${timeLeft} ثانية`;
            
            const timer = setInterval(() => {
              timeLeft--;
              countdownEl.textContent = `جاري التجهيز للتحميل... ${timeLeft} ثانية`;
              
              if (timeLeft <= 0) {
                clearInterval(timer);
                let downloadLink = game.downloadLink;
                if (!downloadLink.startsWith('http')) {
                  downloadLink = 'https://' + downloadLink;
                }
                window.location.href = downloadLink;
              }
            }, 1000);
          });
        } else {
          downloadBtn.disabled = true;
          downloadBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> رابط التحميل غير متوفر';
        }
      } catch (error) {
        console.error('حدث خطأ في تحميل اللعبة:', error);
        showError();
      }
    }

    // دالة عرض الخطأ - معدلة
    function showError() {
      document.querySelector('.container').innerHTML = `
        <div style="text-align: center; margin-top: 50px;">
          <h2 style="color: #ff4b2b; font-size: 2rem;">اللعبة غير موجودة</h2>
          <p style="font-size: 1.2rem; margin: 20px 0;">
            عذراً، اللعبة التي تبحث عنها غير متوفرة أو تم حذفها
          </p>
          <div style="margin-top: 30px;">
            <a href="https://pouyaug.github.io/dowlonplay/" 
               style="display: inline-block; padding: 12px 25px; 
                      background: #7e5bef; color: white; 
                      border-radius: 8px; text-decoration: none;
                      font-size: 1.1rem; margin: 10px;">
              <i class="fas fa-arrow-left"></i> العودة للصفحة الرئيسية
            </a>
            <a href="https://dhdhhddh5.github.io/dowloplay-/" 
               style="display: inline-block; padding: 12px 25px; 
                      background: #2e2e42; color: white; 
                      border-radius: 8px; text-decoration: none;
                      font-size: 1.1rem; margin: 10px;">
              <i class="fas fa-gamepad"></i> تصفح الألعاب الأخرى
            </a>
          </div>
          <div style="margin-top: 30px; color: #aaa; font-size: 0.9rem;">
            <p>رمز الخطأ: GAME_NOT_FOUND</p>
          </div>
        </div>
      `;
    }

    // تحميل اللعبة عند بدء الصفحة
    loadGame();
  </script>
</body>
</html>
